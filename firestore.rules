/**
 * This ruleset enforces a strict user-ownership and role-based model.
 *
 * Core Philosophy:
 * The default posture is deny-all. Access is granted explicitly.
 * - User Profiles (/users): A user can only read, update, or delete their own profile. Admins/officials have full access.
 * - User Listing (/users): Only users with an 'admin' or 'official' role can list all users.
 * - Content (/content): Any authenticated user can read/create. Only the author, an official, or an admin can update/delete.
 * - Access Codes (/accessCodes): Codes are only readable during signup and cannot be listed. They are not writable by clients.
 */
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is signed in.
    function isSignedIn() {
      return request.auth != null;
    }

    // Helper function to check if the requesting user is the owner of the document.
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    // Helper function to securely get the roles of the requesting user.
    // Returns an empty list if the user doc or roles field doesn't exist.
    function getRoles() {
      // Use exists() to prevent errors if the document doesn't exist yet.
      return exists(/databases/$(database)/documents/users/$(request.auth.uid))
             ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles
             : [];
    }

    // Helper function to check if the user is an admin or official.
    function isPrivilegedUser() {
        return isSignedIn() && getRoles().hasAny(['admin', 'official']);
    }
    
    // Rules for the 'users' collection.
    match /users/{userId} {
      // A user can read, update, or delete their OWN profile. Admins/officials have full access.
      allow read, update, delete: if isOwner(userId) || isPrivilegedUser();
      
      // A user can create their own profile document, ensuring the ID matches their auth UID.
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      
      // LIST: Only admins or officials can list all users.
      allow list: if isPrivilegedUser();
    }
    
    // Rules for 'accessCodes' collection.
    match /accessCodes/{codeId} {
        // Only allow a user to read a specific access code document. Do not allow listing.
        // This is to prevent enumeration of codes. The signup logic will attempt to get a specific doc.
        allow get: if isSignedIn();
        // Disallow all client-side writes and lists. Codes should be managed via the Firebase Console or a backend.
        allow list, create, update, delete: if false;
    }


    // Rules for academic 'content' collection.
    match /content/{contentId} {
      // READ: Any authenticated user can read any piece of content.
      allow get, list: if isSignedIn();

      // CREATE: An authenticated user can create content if they set themselves as the author.
      allow create: if isSignedIn() && isOwner(request.resource.data.authorId);

      // UPDATE: Only the original author, an admin, or an official can update.
      // authorId and createdAt fields are immutable to maintain data integrity.
      allow update: if (isOwner(resource.data.authorId) || isPrivilegedUser())
                    && request.resource.data.authorId == resource.data.authorId
                    && request.resource.data.createdAt == resource.data.createdAt;
      
      // DELETE: Only the original author, an admin, or an official can delete.
      allow delete: if isOwner(resource.data.authorId) || isPrivilegedUser();
    }
  }
}
