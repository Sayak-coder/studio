/**
 * This ruleset enforces a strict user-ownership model for the EduBot Central application.
 *
 * Core Philosophy:
 * The security model is built on two key principles: path-based ownership for user profiles
 * and field-based ownership for user-generated content. The default posture is deny-all,
 * ensuring that no data is accessible unless explicitly allowed.
 *
 * Data Structure:
 * - /users/{userId}: Stores private user profile data. Access is restricted to the user whose
 *   UID matches {userId}.
 * - /content/{contentId}: Stores user-generated academic content (notes, PYQs, etc.).
 *   Each document contains an 'authorId' field, which is used to grant write permissions.
 *
 * Key Security Decisions:
 * - User Isolation: A user can only access their own document in the `/users` collection.
 *   Listing all users is disabled to protect privacy.
 * - Content Ownership: Any authenticated user can create content. However, only the user
 *   whose UID matches the `authorId` field in a content document can update or delete it.
 * - Public Read on Content: All content is publicly readable by any authenticated user. This
 *   allows students and other users to access the notes shared by seniors.
 * - Data Integrity: Rules enforce that the `authorId` is correctly set on creation and is
 *   immutable, preventing ownership hijacking.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions for improved readability and reusability.
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Rules for user profiles.
    match /users/{userId} {
      allow get, update, delete: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow list: if false; // CRITICAL: Prevents enumerating all users.
    }

    // Rules for academic content.
    match /content/{contentId} {
      /**
       * @description Any authenticated user can read any piece of content.
       */
      allow get, list: if isSignedIn();

      /**
       * @description Any authenticated user can create a new piece of content,
       *              as long as they correctly set themselves as the author.
       */
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;

      /**
       * @description Only the original author of the content can update it.
       *              The authorId and createdAt fields are immutable.
       */
      allow update: if isSignedIn() && resource.data.authorId == request.auth.uid
                    && request.resource.data.authorId == resource.data.authorId
                    && request.resource.data.createdAt == resource.data.createdAt;
      
      /**
       * @description Only the original author of the content can delete it.
       */
      allow delete: if isSignedIn() && resource.data.authorId == request.auth.uid;
    }
  }
}
