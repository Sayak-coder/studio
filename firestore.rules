/**
 * This ruleset enforces a strict user-ownership and role-based model.
 *
 * Core Philosophy:
 * The default posture is deny-all. Access is granted explicitly.
 * - User Profiles (/users): Only the owner can read/write their own profile. An admin/official can read/write any profile.
 * - User Listing (/users): Only users with an 'admin' or 'official' role can list all users.
 * - Content (/content): Any authenticated user can create/read. Only the author, CR, or an official/admin can update/delete.
 */
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is signed in.
    function isSignedIn() {
      return request.auth != null;
    }

    // Helper function to check if the requesting user is the owner of the document.
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    // Helper function to securely get the roles of the requesting user.
    function getRoles() {
      // Safely access roles, return empty list if document or roles do not exist.
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles;
    }
    
    // Helper function to check if the user has one of the specified roles.
    function hasAnyRole(allowedRoles) {
      return isSignedIn() && getRoles().hasAny(allowedRoles);
    }

    // Rules for the 'users' collection.
    match /users/{userId} {
      // READ: An admin/official can read any profile. A user can read their own.
      allow get: if hasAnyRole(['admin', 'official']) || isOwner(userId);
      
      // CREATE: A user can create their own profile, ensuring the ID matches their auth UID.
      allow create: if isOwner(userId) && request.resource.data.id == userId;

      // UPDATE: An admin/official can modify any profile. A user can modify their own.
      // This is crucial for adding new roles to the 'roles' array.
      allow update: if hasAnyRole(['admin', 'official']) || isOwner(userId);

      // DELETE: An admin/official can delete any profile. A user can delete their own.
      allow delete: if hasAnyRole(['admin', 'official']) || isOwner(userId);
      
      // LIST: Only admins or officials can list all users.
      allow list: if hasAnyRole(['admin', 'official']);
    }

    // Rules for academic 'content' collection.
    match /content/{contentId} {
      // READ: Any authenticated user can read any piece of content.
      allow get, list: if isSignedIn();

      // CREATE: Any authenticated user can create content, but must set themselves as the author.
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;

      // UPDATE: Only the original author, an admin, an official, or a CR can update.
      // authorId and createdAt fields are immutable to maintain data integrity.
      allow update: if (isOwner(resource.data.authorId) || hasAnyRole(['admin', 'official', 'class-representative']))
                    && request.resource.data.authorId == resource.data.authorId
                    && request.resource.data.createdAt == resource.data.createdAt;
      
      // DELETE: Only the original author, an admin, an official, or a CR can delete.
      allow delete: if isOwner(resource.data.authorId) || hasAnyRole(['admin', 'official', 'class-representative']);
    }
  }
}
