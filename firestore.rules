/**
 * This ruleset enforces a strict user-ownership and role-based model.
 *
 * Core Philosophy:
 * The default posture is deny-all. Access is granted explicitly.
 * - User Profiles (/users): Only the owner can read/write their own profile. An admin/official can read/write any profile.
 * - User Listing (/users): Only users with an 'admin' or 'official' role can list all users. This is checked by reading the requesting user's own profile.
 * - Content (/content): Any authenticated user can create/read. Only the author can update/delete.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function for improved readability and reusability.
    function isSignedIn() {
      return request.auth != null;
    }

    // Helper function to check if the requesting user is the owner of the document.
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    // Rules for user profiles.
    match /users/{userId} {
      // An official/admin can read any profile. A user can read their own profile.
      allow get: if (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'official']) || isOwner(userId);
      
      // An official/admin can update or delete any profile. A user can update their own.
      allow update, delete: if (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'official']) || isOwner(userId);
      
      // A user can create their own profile, ensuring the ID matches their auth UID.
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      
      // Allow users with 'admin' or 'official' role to list all users.
      // This rule is secure because it only checks the requesting user's role document.
      allow list: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'official'];
    }

    // Rules for academic content.
    match /content/{contentId} {
      /**
       * @description Any authenticated user can read any piece of content.
       */
      allow get, list: if isSignedIn();

      /**
       * @description Any authenticated user can create a new piece of content,
       *              as long as they correctly set themselves as the author.
       */
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;

      /**
       * @description Only the original author of the content can update it.
       *              The authorId and createdAt fields are immutable.
       */
      allow update: if isSignedIn() && resource.data.authorId == request.auth.uid
                    && request.resource.data.authorId == resource.data.authorId
                    && request.resource.data.createdAt == resource.data.createdAt;
      
      /**
       * @description Only the original author of the content can delete it.
       */
      allow delete: if isSignedIn() && resource.data.authorId == request.auth.uid;
    }
  }
}

    