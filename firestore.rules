/**
 * This ruleset enforces a strict user-ownership model for the EduBot Central application.
 *
 * Core Philosophy:
 * The security model is built on two key principles: path-based ownership for user profiles
 * and field-based ownership for user-generated content. The default posture is deny-all,
 * ensuring that no data is accessible unless explicitly allowed.
 *
 * Data Structure:
 * - /users/{userId}: Stores private user profile data. Access is restricted to the user whose
 *   UID matches {userId}.
 * - /content/{contentId}: Stores user-generated academic content (notes, PYQs, etc.).
 *   Each document contains an 'authorId' field, which is used to grant write permissions.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions for improved readability and reusability.
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Rules for user profiles.
    match /users/{userId} {
      allow get, update, delete: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow list: if false; // CRITICAL: Prevents enumerating all users.
    }

    // Rules for academic content.
    match /content/{contentId} {
      /**
       * @description Any authenticated user can read any piece of content.
       */
      allow get, list: if isSignedIn();

      /**
       * @description Any authenticated user can create a new piece of content,
       *              as long as they correctly set themselves as the author.
       */
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;

      /**
       * @description Only the original author of the content can update it.
       *              The authorId and createdAt fields are immutable.
       */
      allow update: if isSignedIn() && resource.data.authorId == request.auth.uid
                    && request.resource.data.authorId == resource.data.authorId
                    && request.resource.data.createdAt == resource.data.createdAt;
      
      /**
       * @description Only the original author of the content can delete it.
       */
      allow delete: if isSignedIn() && resource.data.authorId == request.auth.uid;
    }
  }
}

service firebase.storage {
  match /b/{bucket}/o {
    // Allow reads by anyone (e.g., for public images or files).
    // In a real app, you'd likely restrict this further.
    allow read: if true;

    // Allow writes only for authenticated users.
    // The file path must match the user's UID.
    // This rule ensures users can only upload files to their own "folder".
    // We also limit the file size to 5MB.
    match /content/{userId}/{allPaths=**} {
      allow write: if request.auth != null 
                   && request.auth.uid == userId
                   && request.resource.size < 5 * 1024 * 1024
                   && request.resource.contentType.matches('image/.*|application/pdf');
    }
  }
}
